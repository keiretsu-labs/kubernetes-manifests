---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openclaw
spec:
  replicas: 1
  revisionHistoryLimit: 3
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: openclaw
  template:
    metadata:
      labels:
        app.kubernetes.io/name: openclaw
    spec:
      serviceAccountName: tailscale
      imagePullSecrets:
        - name: zot-pull-secret
      initContainers:
        - name: sysctler
          image: ghcr.io/tailscale/tailscale:v1.94.1
          command: [/bin/sh, -c]
          args:
            - >-
              sysctl -w net.ipv4.ip_forward=1 &&
              if sysctl net.ipv6.conf.all.forwarding;
              then sysctl -w net.ipv6.conf.all.forwarding=1; fi
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 256Mi
          securityContext:
            privileged: true
        - name: init-workspace
          image: alpine:3.21
          command: [sh, -c]
          args:
            - |
              set -e
              apk add --no-cache rsync >/dev/null 2>&1
              echo "[init-workspace] Syncing workspaces from OCI image (preserving agent changes)..."
              rsync -av --update /opt/workspace/workspaces/ /home/node/.openclaw/workspaces/
              echo "[init-workspace] Downloading MCP integration plugin..."
              PLUGIN_DIR=/home/node/.openclaw/extensions/openclaw-mcp-plugin
              if [ ! -f "$PLUGIN_DIR/package.json" ]; then
                mkdir -p "$PLUGIN_DIR"
                wget -qO- https://github.com/lunarpulse/openclaw-mcp-plugin/archive/refs/heads/main.tar.gz \
                  | tar xz --strip-components=1 -C "$PLUGIN_DIR"
              fi
              if [ ! -f "$PLUGIN_DIR/openclaw.plugin.json" ]; then
                cat > "$PLUGIN_DIR/openclaw.plugin.json" <<'MANIFEST'
              {"id":"mcp-integration","configSchema":{"type":"object","properties":{"enabled":{"type":"boolean"},"servers":{"type":"object"}},"additionalProperties":true}}
              MANIFEST
              fi
              if [ ! -f "$PLUGIN_DIR/index.js" ]; then
                echo 'export { default } from "./src/index.js";' > "$PLUGIN_DIR/index.js"
              fi
              sed -i 's/options\.sessionId || null/options?.sessionId/' "$PLUGIN_DIR/src/http-transport.js"
              echo "[init-workspace] Updating config..."
              cp /opt/config/openclaw.json /home/node/.openclaw/clawdbot.json
              echo "[init-workspace] Updating cron jobs..."
              mkdir -p /home/node/.openclaw/cron
              cp /opt/config/cron-jobs.json /home/node/.openclaw/cron/jobs.json
              echo "[init-workspace] Setting up git config..."
              cat > /home/node/.openclaw/.gitconfig <<'GITCFG'
              [credential "https://github.com"]
                helper = !gh auth git-credential
              [user]
                name = rajsinghtechbot
                email = king360raj@gmail.com
              GITCFG
              echo "[init-workspace] Fixing ownership..."
              chown -R 1000:1000 /home/node/.openclaw
              echo "[init-workspace] Done"
          volumeMounts:
            - name: data
              mountPath: /home/node/.openclaw
            - name: workspace
              mountPath: /opt/workspace
              readOnly: true
            - name: config
              mountPath: /opt/config
              readOnly: true
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 512Mi
        - name: init-extensions
          image: oci.killinit.cc/openclaw/openclaw:latest
          imagePullPolicy: Always
          command: [sh, -c]
          args:
            - |
              set -e
              cd /home/node/.openclaw/extensions/openclaw-mcp-plugin
              if [ ! -d node_modules ]; then
                echo "[init-extensions] Installing MCP plugin dependencies..."
                npm install --production
              else
                echo "[init-extensions] Dependencies already installed, skipping."
              fi
          volumeMounts:
            - name: data
              mountPath: /home/node/.openclaw
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              memory: 512Mi
      containers:
        - name: openclaw
          image: oci.killinit.cc/openclaw/openclaw:latest
          imagePullPolicy: Always
          env:
            - name: KUBECONFIG
              value: /home/node/.kube/config
            - name: GIT_CONFIG_GLOBAL
              value: /home/node/.openclaw/.gitconfig
            - name: GIT_AUTHOR_NAME
              value: rajsinghtechbot
            - name: GIT_AUTHOR_EMAIL
              value: king360raj@gmail.com
            - name: GIT_COMMITTER_NAME
              value: rajsinghtechbot
            - name: GIT_COMMITTER_EMAIL
              value: king360raj@gmail.com
          envFrom:
            - secretRef:
                name: openclaw-secrets
          # WORKAROUND: probes removed â€” gateway binds to loopback only
          # (openclaw/openclaw#19004) so kubelet can't reach it. Restore
          # tcpSocket probes on port 18789 once #19004 is fixed and bind
          # reverts to lan.
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              memory: 4Gi
          volumeMounts:
            - name: data
              mountPath: /home/node/.openclaw
            - name: kubeconfig
              mountPath: /home/node/.kube
              readOnly: true
        - name: tailscale
          image: ghcr.io/tailscale/tailscale:v1.94.1
          securityContext:
            privileged: true
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: TS_KUBE_SECRET
              value: ""
            - name: TS_USERSPACE
              value: "false"
            - name: TS_STATE_DIR
              value: /dev/shm
            - name: TS_AUTHKEY
              valueFrom:
                secretKeyRef:
                  name: ts-oauth
                  key: TS_AUTHKEY
            - name: TS_ACCEPT_DNS
              value: "true"
            - name: TS_EXTRA_ARGS
              value: "--advertise-tags=tag:k8s,tag:ottawa --accept-routes"
            - name: TS_HOSTNAME
              value: $(POD_NAME)
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              memory: 512Mi
        - name: chromium
          image: zenika/alpine-chrome:124
          imagePullPolicy: IfNotPresent
          command:
            - chromium-browser
          args:
            - --headless
            - --disable-gpu
            - --no-sandbox
            - --disable-dev-shm-usage
            - --remote-debugging-address=0.0.0.0
            - --remote-debugging-port=9222
            - --user-data-dir=/tmp/chromium
          env:
            - name: XDG_CACHE_HOME
              value: /tmp
          ports:
            - name: cdp
              containerPort: 9222
              protocol: TCP
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: "1"
              memory: 1Gi
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            tcpSocket:
              port: 9222
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 6
            timeoutSeconds: 5
          readinessProbe:
            tcpSocket:
              port: 9222
            initialDelaySeconds: 5
            periodSeconds: 10
          startupProbe:
            tcpSocket:
              port: 9222
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 12
            timeoutSeconds: 5
        - name: scrapling
          image: pyd4vinci/scrapling:latest
          args: ["mcp", "--http", "--host", "0.0.0.0", "--port", "8000"]
          ports:
            - name: mcp
              containerPort: 8000
              protocol: TCP
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 1536Mi
          readinessProbe:
            tcpSocket:
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 30
            failureThreshold: 3
          startupProbe:
            tcpSocket:
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 12
      terminationGracePeriodSeconds: 60
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: openclaw-data
        - name: workspace
          image:
            reference: oci.killinit.cc/openclaw/workspace:latest
            pullPolicy: Always
        - name: config
          configMap:
            name: openclaw-config
        - name: kubeconfig
          secret:
            secretName: openclaw-kubeconfig
        - name: tmp
          emptyDir: {}
