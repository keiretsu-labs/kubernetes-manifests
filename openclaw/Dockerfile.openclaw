# syntax=docker/dockerfile:1

# Tool versions â€” bump these to update (or use Renovate)
ARG KUBECTL_V=v1.35.1
ARG FLUX_V=v2.7.5
ARG HELM_V=v4.1.1
ARG KUSTOMIZE_V=v5.8.1
ARG YQ_V=v4.52.4
ARG SOPS_V=v3.12.1
ARG JQ_V=jq-1.8.1
ARG GH_V=2.87.2
ARG GOGCLI_V=0.9.0

# Stage 1: download tools (each RUN = cached layer)
FROM debian:bookworm-slim AS tools

ARG TARGETARCH
ARG KUBECTL_V FLUX_V HELM_V KUSTOMIZE_V YQ_V SOPS_V JQ_V GH_V GOGCLI_V

RUN apt-get update && apt-get install -y --no-install-recommends curl ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /tools

RUN curl -fsSL --retry 5 --retry-delay 2 -o kubectl \
      "https://dl.k8s.io/release/${KUBECTL_V}/bin/linux/${TARGETARCH}/kubectl" \
    && chmod +x kubectl

RUN curl -fsSL --retry 5 --retry-delay 2 \
      "https://github.com/fluxcd/flux2/releases/download/${FLUX_V}/flux_${FLUX_V#v}_linux_${TARGETARCH}.tar.gz" \
    | tar xz flux

RUN curl -fsSL --retry 5 --retry-delay 2 \
      "https://get.helm.sh/helm-${HELM_V}-linux-${TARGETARCH}.tar.gz" \
    | tar xz --strip-components=1 "linux-${TARGETARCH}/helm"

RUN curl -fsSL --retry 5 --retry-delay 2 \
      "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KUSTOMIZE_V}/kustomize_${KUSTOMIZE_V}_linux_${TARGETARCH}.tar.gz" \
    | tar xz kustomize

RUN curl -fsSL --retry 5 --retry-delay 2 -o yq \
      "https://github.com/mikefarah/yq/releases/download/${YQ_V}/yq_linux_${TARGETARCH}" \
    && chmod +x yq

RUN curl -fsSL --retry 5 --retry-delay 2 -o sops \
      "https://github.com/getsops/sops/releases/download/${SOPS_V}/sops-${SOPS_V}.linux.${TARGETARCH}" \
    && chmod +x sops

RUN curl -fsSL --retry 5 --retry-delay 2 -o jq \
      "https://github.com/jqlang/jq/releases/download/${JQ_V}/jq-linux-${TARGETARCH}" \
    && chmod +x jq

RUN curl -fsSL --retry 5 --retry-delay 2 \
      "https://github.com/cli/cli/releases/download/v${GH_V}/gh_${GH_V}_linux_${TARGETARCH}.tar.gz" \
    | tar xz --strip-components=2 "gh_${GH_V}_linux_${TARGETARCH}/bin/gh"

RUN curl -fsSL --retry 5 --retry-delay 2 \
      "https://github.com/steipete/gogcli/releases/download/v${GOGCLI_V}/gogcli_${GOGCLI_V}_linux_${TARGETARCH}.tar.gz" \
    | tar xz gog

# Stage 2: final image
FROM ghcr.io/openclaw/openclaw:2026.2.22

USER root
COPY --from=tools /tools/ /usr/local/bin/

# Install MCP integration plugin for connecting to external MCP servers (e.g. Scrapling)
RUN apt-get update && apt-get install -y --no-install-recommends curl ca-certificates \
    && mkdir -p /home/node/.openclaw/extensions/openclaw-mcp-plugin \
    && cd /home/node/.openclaw/extensions/openclaw-mcp-plugin \
    && curl -fsSL https://github.com/lunarpulse/openclaw-mcp-plugin/archive/refs/heads/main.tar.gz \
       | tar xz --strip-components=1 \
    && npm install --production \
    && chown -R node:node /home/node/.openclaw/extensions \
    && apt-get purge -y curl && apt-get autoremove -y && rm -rf /var/lib/apt/lists/*

USER node
