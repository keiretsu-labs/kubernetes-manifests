---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
  namespace: openclaw
spec:
  interval: 30m
  chart:
    spec:
      chart: openclaw
      version: 1.3.3
      sourceRef:
        kind: HelmRepository
        name: openclaw
        namespace: flux-system
  install:
    remediation:
      retries: 0
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 0
  values:
    configMode: merge
    app-template:
      controllers:
        main:
          serviceAccount:
            name: tailscale
          initContainers:
            sysctler:
              image:
                repository: ghcr.io/tailscale/tailscale
                tag: v1.94.1
              command:
                - /bin/sh
                - -c
              args:
                - >-
                  sysctl -w net.ipv4.ip_forward=1 &&
                  if sysctl net.ipv6.conf.all.forwarding;
                  then sysctl -w net.ipv6.conf.all.forwarding=1; fi
              securityContext:
                privileged: true
          containers:
            main:
              envFrom:
                - secretRef:
                    name: openclaw-secrets
            tailscale:
              image:
                repository: ghcr.io/tailscale/tailscale
                tag: v1.94.1
              securityContext:
                privileged: true
              env:
                TS_KUBE_SECRET: openclaw-ts-state
                TS_STATE: kube:openclaw-ts-state
                TS_USERSPACE: "false"
                TS_AUTHKEY:
                  valueFrom:
                    secretKeyRef:
                      name: ts-oauth
                      key: TS_AUTHKEY
                TS_ACCEPT_DNS: "true"
                TS_EXTRA_ARGS: "--advertise-tags=tag:k8s,tag:ottawa --accept-routes"
                TS_HOSTNAME: openclaw
      configMaps:
        config:
          data:
            openclaw.json: |
              {
                "gateway": {
                  "port": 18789,
                  "mode": "local",
                  "bind": "lan",
                  "auth": {
                    "mode": "token",
                    "allowTailscale": true
                  },
                  "controlUi": {
                    "enabled": true,
                    "allowInsecureAuth": true
                  }
                },
                "browser": {
                  "enabled": true,
                  "cdpUrl": "http://localhost:9222"
                },
                "models": {
                  "mode": "merge",
                  "providers": {
                    "vllm": {
                      "baseUrl": "http://stpetersburg-vllm/v1",
                      "apiKey": "unused",
                      "api": "openai-completions",
                      "models": [
                        {
                          "id": "Qwen3-Coder-Next",
                          "name": "Qwen3 Coder Next",
                          "input": ["text"],
                          "contextWindow": 131072,
                          "maxTokens": 8192
                        }
                      ]
                    }
                  }
                },
                "agents": {
                  "defaults": {
                    "workspace": "/home/node/.openclaw/workspace",
                    "model": {
                      "primary": "vllm/Qwen3-Coder-Next"
                    },
                    "userTimezone": "America/New_York",
                    "timeoutSeconds": 600,
                    "maxConcurrent": 1
                  }
                },
                "session": {
                  "scope": "per-sender",
                  "idleMinutes": 60
                },
                "logging": {
                  "level": "info",
                  "consoleStyle": "compact",
                  "redactSensitive": "tools"
                },
                "tools": {
                  "profile": "full",
                  "web": {
                    "search": {
                      "enabled": false
                    },
                    "fetch": {
                      "enabled": true
                    }
                  }
                },
                "channels": {
                  "discord": {
                    "enabled": true,
                    "groupPolicy": "open",
                    "guilds": {
                      "*": {
                        "requireMention": false
                      }
                    },
                    "dm": {
                      "policy": "pairing"
                    },
                    "configWrites": true
                  }
                }
              }
      persistence:
        data:
          enabled: true
          size: 5Gi
          accessMode: ReadWriteOnce
