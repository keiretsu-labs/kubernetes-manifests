---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
  namespace: openclaw
spec:
  interval: 30m
  chart:
    spec:
      chart: openclaw
      version: 1.3.8
      sourceRef:
        kind: HelmRepository
        name: openclaw
        namespace: flux-system
  install:
    remediation:
      retries: 0
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 0
  values:
    configMode: merge
    app-template:
      controllers:
        main:
          serviceAccount:
            name: tailscale
          initContainers:
            sysctler:
              image:
                repository: ghcr.io/tailscale/tailscale
                tag: v1.94.1
              command:
                - /bin/sh
                - -c
              args:
                - >-
                  sysctl -w net.ipv4.ip_forward=1 &&
                  if sysctl net.ipv6.conf.all.forwarding;
                  then sysctl -w net.ipv6.conf.all.forwarding=1; fi
              securityContext:
                privileged: true
            init-skills:
              command:
                - sh
                - -c
                - |
                  log() { echo "[$(date -Iseconds)] [init-skills] $*"; }
                  log "Starting tools and skills initialization"

                  BIN=/home/node/.openclaw/bin
                  mkdir -p "$BIN"
                  ARCH=$(uname -m)
                  case "$ARCH" in x86_64) ARCH=amd64;; aarch64) ARCH=arm64;; esac

                  # Remove stale 0-byte files from previous failed installs
                  find "$BIN" -maxdepth 1 -type f -empty -delete 2>/dev/null

                  # Check which tools are missing
                  MISSING=""
                  for t in kubectl flux helm kustomize yq sops jq; do
                    [ ! -f "$BIN/$t" ] && MISSING="$MISSING $t"
                  done
                  if [ -z "$MISSING" ]; then
                    log "All tools already installed, skipping downloads"
                  else
                    log "Missing tools:$MISSING"
                    # Connectivity gate â€” init containers often lack egress before sidecars start.
                    # Wait up to 15s for github.com to be reachable, bail if not.
                    ONLINE=false
                    for i in 1 2 3; do
                      if curl -fsSo /dev/null --connect-timeout 5 "https://github.com" 2>/dev/null; then
                        ONLINE=true; break
                      fi
                      log "Waiting for network... (attempt $i/3)"
                      sleep 2
                    done
                    if [ "$ONLINE" = false ]; then
                      log "WARNING: github.com unreachable from init container â€” skipping tool downloads"
                      log "Tools can be installed later via: kubectl exec -n openclaw <pod> -c main -- sh -c '...'"
                    else
                      # Version resolver via curl redirect header (no API, no rate limits)
                      ghrel() { curl -sI --connect-timeout 10 "https://github.com/$1/releases/latest" 2>/dev/null | grep -i "^location:" | grep -oE '[^/]+$' | tr -d '\r\n'; }
                      fetch() { curl -fsSL --connect-timeout 15 --retry 2 -o "$1" "$2"; }
                      fetch_tar() {
                        curl -fsSL --connect-timeout 15 --retry 2 "$1" -o /tmp/_dl.tar.gz && tar xzf /tmp/_dl.tar.gz -C "$2" $3
                        local rc=$?; rm -f /tmp/_dl.tar.gz; return $rc
                      }

                      if [ ! -f "$BIN/kubectl" ]; then
                        log "Installing kubectl..."
                        KVER=$(curl -fsSL --connect-timeout 10 https://dl.k8s.io/release/stable.txt) &&
                        fetch "$BIN/kubectl" "https://dl.k8s.io/release/$KVER/bin/linux/$ARCH/kubectl" &&
                        chmod +x "$BIN/kubectl" &&
                        log "Installed kubectl $KVER" || log "WARNING: kubectl install failed"
                      fi

                      if [ ! -f "$BIN/flux" ]; then
                        VER=$(ghrel fluxcd/flux2); VER=${VER#v}
                        if [ -n "$VER" ]; then
                          log "Installing flux v$VER..."
                          fetch_tar "https://github.com/fluxcd/flux2/releases/download/v${VER}/flux_${VER}_linux_${ARCH}.tar.gz" "$BIN" flux &&
                          log "Installed flux" || log "WARNING: flux install failed"
                        else log "WARNING: could not detect flux version"; fi
                      fi

                      if [ ! -f "$BIN/helm" ]; then
                        VER=$(ghrel helm/helm)
                        if [ -n "$VER" ]; then
                          log "Installing helm $VER..."
                          fetch_tar "https://get.helm.sh/helm-${VER}-linux-${ARCH}.tar.gz" /tmp "" &&
                          mv /tmp/linux-${ARCH}/helm "$BIN/" && rm -rf /tmp/linux-${ARCH} &&
                          log "Installed helm" || log "WARNING: helm install failed"
                        else log "WARNING: could not detect helm version"; fi
                      fi

                      if [ ! -f "$BIN/kustomize" ]; then
                        VER=$(ghrel kubernetes-sigs/kustomize); VER=$(echo "$VER" | sed 's|kustomize/||')
                        if [ -n "$VER" ]; then
                          log "Installing kustomize $VER..."
                          fetch_tar "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${VER}/kustomize_${VER}_linux_${ARCH}.tar.gz" "$BIN" "" &&
                          log "Installed kustomize" || log "WARNING: kustomize install failed"
                        else log "WARNING: could not detect kustomize version"; fi
                      fi

                      if [ ! -f "$BIN/yq" ]; then
                        log "Installing yq..."
                        fetch "$BIN/yq" "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_${ARCH}" &&
                        chmod +x "$BIN/yq" && log "Installed yq" || { rm -f "$BIN/yq"; log "WARNING: yq install failed"; }
                      fi

                      if [ ! -f "$BIN/sops" ]; then
                        VER=$(ghrel getsops/sops)
                        if [ -n "$VER" ]; then
                          log "Installing sops $VER..."
                          fetch "$BIN/sops" "https://github.com/getsops/sops/releases/download/${VER}/sops-${VER}.linux.${ARCH}" &&
                          chmod +x "$BIN/sops" && log "Installed sops" || { rm -f "$BIN/sops"; log "WARNING: sops install failed"; }
                        else log "WARNING: could not detect sops version"; fi
                      fi

                      if ! command -v jq >/dev/null 2>&1 && [ ! -f "$BIN/jq" ]; then
                        log "Installing jq..."
                        fetch "$BIN/jq" "https://github.com/jqlang/jq/releases/latest/download/jq-linux-${ARCH}" &&
                        chmod +x "$BIN/jq" && log "Installed jq" || { rm -f "$BIN/jq"; log "WARNING: jq install failed"; }
                      fi
                    fi
                  fi

                  mkdir -p /home/node/.openclaw/workspace/skills
                  cd /home/node/.openclaw/workspace
                  for skill in weather; do
                    if [ -n "$skill" ] && [ ! -d "skills/${skill##*/}" ]; then
                      log "Installing skill: $skill"
                      npx -y clawhub install "$skill" --no-input || log "WARNING: Failed to install skill: $skill"
                    else
                      log "Skill already installed: $skill"
                    fi
                  done

                  log "Tools and skills initialization complete"
              env:
                HOME: /tmp
                NPM_CONFIG_CACHE: /tmp/.npm
          containers:
            main:
              env:
                PATH: /home/node/.openclaw/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
              envFrom:
                - secretRef:
                    name: openclaw-secrets
            code-server:
              image:
                repository: lscr.io/linuxserver/code-server
                tag: latest
              env:
                PUID: "0"
                PGID: "0"
                TZ: America/New_York
                DEFAULT_WORKSPACE: /home/node/.openclaw
                PASSWORD: ${DEFAULT_PASSWORD}
            tailscale:
              image:
                repository: ghcr.io/tailscale/tailscale
                tag: v1.94.1
              securityContext:
                privileged: true
              env:
                TS_KUBE_SECRET: ""
                TS_USERSPACE: "false"
                TS_STATE_DIR: /dev/shm
                TS_AUTHKEY:
                  valueFrom:
                    secretKeyRef:
                      name: ts-oauth
                      key: TS_AUTHKEY
                TS_ACCEPT_DNS: "true"
                TS_EXTRA_ARGS: "--advertise-tags=tag:k8s,tag:ottawa --accept-routes"
                TS_HOSTNAME: openclaw
      configMaps:
        config:
          data:
            openclaw.json: |
              {
                "gateway": {
                  "port": 18789,
                  "mode": "local",
                  "bind": "lan",
                  "auth": {
                    "mode": "token",
                    "allowTailscale": true
                  },
                  "controlUi": {
                    "enabled": true,
                    "allowInsecureAuth": true
                  }
                },
                "browser": {
                  "enabled": true,
                  "cdpUrl": "http://localhost:9222"
                },
                "models": {
                  "mode": "merge",
                  "providers": {
                    "llama-cpp": {
                      "baseUrl": "http://stpetersburg-llama-cpp/v1",
                      "apiKey": "unused",
                      "api": "openai-completions",
                      "models": [
                        {
                          "id": "Qwen3-Coder-Next",
                          "name": "Qwen3 Coder Next",
                          "input": ["text"],
                          "contextWindow": 131072,
                          "maxTokens": 8192
                        }
                      ]
                    }
                  }
                },
                "agents": {
                  "defaults": {
                    "workspace": "/home/node/.openclaw/workspace",
                    "model": {
                      "primary": "llama-cpp/Qwen3-Coder-Next"
                    },
                    "userTimezone": "America/New_York",
                    "timeoutSeconds": 600,
                    "maxConcurrent": 1,
                    "subagents": {
                      "maxConcurrent": 8
                    }
                  },
                  "list": [
                    {
                      "id": "main",
                      "default": true,
                      "identity": {
                        "name": "OpenClaw",
                        "emoji": "ðŸ¦ž"
                      },
                      "model": {
                        "primary": "llama-cpp/Qwen3-Coder-Next"
                      },
                      "subagents": {
                        "allowAgents": ["claw-manager"]
                      }
                    },
                    {
                      "id": "claw-manager",
                      "identity": {
                        "name": "Claw Manager",
                        "emoji": "ðŸ¦ž"
                      },
                      "model": {
                        "primary": "llama-cpp/Qwen3-Coder-Next"
                      },
                      "subagents": {
                        "allowAgents": ["*"]
                      }
                    }
                  ]
                },
                "session": {
                  "scope": "per-sender",
                  "idleMinutes": 60
                },
                "logging": {
                  "level": "info",
                  "consoleStyle": "compact",
                  "redactSensitive": "tools"
                },
                "tools": {
                  "profile": "full",
                  "web": {
                    "search": {
                      "enabled": false
                    },
                    "fetch": {
                      "enabled": true
                    }
                  }
                },
                "channels": {
                  "discord": {
                    "enabled": true,
                    "groupPolicy": "open",
                    "guilds": {
                      "*": {
                        "requireMention": false
                      }
                    },
                    "dm": {
                      "policy": "pairing"
                    },
                    "configWrites": true
                  }
                }
              }
      service:
        code-server:
          controller: main
          ports:
            http:
              port: 8443
      persistence:
        data:
          enabled: true
          size: 5Gi
          accessMode: ReadWriteOnce
          advancedMounts:
            main:
              init-skills:
                - path: /home/node/.openclaw
              main:
                - path: /home/node/.openclaw
              code-server:
                - path: /home/node/.openclaw
