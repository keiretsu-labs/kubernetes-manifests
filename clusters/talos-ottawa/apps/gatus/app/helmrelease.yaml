---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gatus
spec:
  interval: 30m
  chart:
    spec:
      chart: gatus
      version: 1.5.0 # Pinned version from original kustomization
      sourceRef:
        kind: HelmRepository
        name: twin
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    image:
      tag: latest
    # envFrom:
    #   - secretRef:
    #       name: gatus
      # - secretRef:
      #     name: gatus-postgres-app
    config:
      #storage:
        #type: postgres
        #path: "$${uri}"
      alerting:
        discord:
          webhook-url: "${DISCORD_WEBHOOK_URL}"
          failure-threshold: 3
          success-threshold: 2
      ui:
        title: "K8s Ottawa Status"
        description: "GitOps-managed Kubernetes cluster monitoring - Single source of truth for infrastructure health"
        header: "K8s-Ottawa Infrastructure Dashboard"
        logo: "https://raw.githubusercontent.com/kubernetes/kubernetes/master/logo/logo.png"
        link: "https://github.com/keiretsu-labs/kubernetes-manifests"
        buttons:
          - name: "GitOps Repository"
            link: "https://github.com/keiretsu-labs/kubernetes-manifests"
          # - name: "Portfolio"
          #   link: "https://www.${CLUSTER_DOMAIN}"
      endpoints:
        - name: Rook Ceph MGR
          group: Servers
          url: http://rook-ceph-mgr.rook-ceph:9283/metrics
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: (K8s Cluster) Ottawa
          group: Tailscale
          url: https://ottawa-k8s-operator.keiretsu.ts.net:443/readyz
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: (K8s Cluster) Robbinsdale
          group: Tailscale
          url: https://robbinsdale-k8s-operator.keiretsu.ts.net:443/readyz
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: (K8s Cluster) StPetersburg
          group: Tailscale
          url: https://stpetersburg-k8s-operator.keiretsu.ts.net:443/readyz
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Rei (K8s Node)
          group: Servers
          url: tcp://rei.killinit.internal:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Asuka (K8s Node)
          group: Servers
          url: tcp://asuka.killinit.internal:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Kaji (K8s Node)
          group: Servers
          url: tcp://kaji.killinit.internal:6443
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Nagato (NAS)
          group: Servers
          url: tcp://nagato.killinit.internal:445
          interval: 60s
          client:
            insecure: true
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jetkvm
          group: Servers
          url: tcp://jetkvm.killinit.internal:80
          interval: 60s
          client:
            insecure: true
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Kubernetes API
          group: Kubernetes
          url: https://k8s.killinit.internal:6443/readyz
          interval: 60s
          client:
            insecure: true
          conditions:
            - "[STATUS] == 401"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Envoy-Public
          group: Networking
          url: https://status.${CLUSTER_DOMAIN}
          interval: 60s
          client:
            dns-resolver: "tcp://1.1.1.1:53"
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Envoy-Tailscale
          group: Networking
          url: https://status.${CLUSTER_DOMAIN}
          interval: 60s
          client:
            dns-resolver: "tcp://ts-pihole-dns.home:53"
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Envoy-Private
          group: Networking
          url: https://status.${CLUSTER_DOMAIN}
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
            - "[CERTIFICATE_EXPIRATION] > 168h"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Plex
          group: Media
          url: http://plex.media:32400/identity
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellyfin
          group: Media
          url: http://jellyfin.media:8096/health
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellystat
          group: Media
          url: http://jellystat.media:3000
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Jellyseerr
          group: Media
          url: http://jellyseerr.media:5055
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Radarr 4k Remux
          group: Media
          url: http://radarr-4kremux.media:7878
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Radarr 4k
          group: Media
          url: http://radarr-4k.media:7878
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Radarr 1080p
          group: Media
          url: http://radarr-1080p.media:7878
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Radarr Anime
          group: Media
          url: http://radarr-anime.media:7878
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Sonarr 4k
          group: Media
          url: http://sonarr-4k.media:8989
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Sonarr 1080p
          group: Media
          url: http://sonarr-1080p.media:8989
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Sonarr Anime
          group: Media
          url: http://sonarr-anime.media:8989
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Prowlarr
          group: Media
          url: http://prowlarr.media:9696
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Bazarr 4k Remux
          group: Media
          url: http://bazarr-4kremux.media:6767
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Bazarr 4k
          group: Media
          url: http://bazarr-4k.media:6767
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Bazarr 1080p
          group: Media
          url: http://bazarr-1080p.media:6767
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Bazarr Anime
          group: Media
          url: http://bazarr-anime.media:6767
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        # === NEW: Kubernetes Control Plane ===
        - name: etcd
          group: Kubernetes
          url: tcp://kube-prometheus-stack-kube-etcd.kube-system:2381
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 500"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: CoreDNS
          group: Kubernetes
          url: http://kube-dns.kube-system:9153/metrics
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        # === NEW: Storage ===
        - name: Ceph MGR
          group: Storage
          url: http://rook-ceph-mgr.rook-ceph:9283
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Garage
          group: Storage
          url: tcp://garage.garage:3900
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Garage WebUI
          group: Storage
          url: http://garage-webui.garage:80
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
          alerts:
            - type: discord
              send-on-resolved: true
        # === NEW: Monitoring Stack ===
        - name: Prometheus
          group: Monitoring
          url: http://kube-prometheus-stack-prometheus.monitoring:9090/-/healthy
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Alertmanager
          group: Monitoring
          url: http://kube-prometheus-stack-alertmanager.monitoring:9093
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Grafana
          group: Monitoring
          url: http://grafana-service.monitoring:3000/api/health
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 2000"
          alerts:
            - type: discord
              send-on-resolved: true
        # === NEW: Applications ===
        - name: Immich Server
          group: Applications
          url: http://immich-server.immich:2283
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Immich Machine Learning
          group: Applications
          url: http://immich-machine-learning.immich:3003
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 5000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Temporal Frontend
          group: Applications
          url: tcp://temporal-frontend.temporal:7233
          interval: 60s
          conditions:
            - "[CONNECTED] == true"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
        - name: Temporal Web UI
          group: Applications
          url: http://temporal-web.temporal:8080
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 3000"
          alerts:
            - type: discord
              send-on-resolved: true
        # === NEW: GitOps ===
        - name: Flux Source Controller
          group: GitOps
          url: http://source-controller.flux-system:80
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true
            - "[RESPONSE_TIME] < 1000"
          alerts:
            - type: discord
              send-on-resolved: true