---
apiVersion: batch/v1
kind: Job
metadata:
  name: fleet-init-db
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-5"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      containers:
        - name: init-db
          image: percona/percona-xtradb-cluster:8.0.36-28.1
          command:
            - /bin/bash
            - -c
            - |
              echo "Waiting for MySQL to be ready..."
              until mysql -h fleet-mysql-pxc -uroot -p$MYSQL_ROOT_PASSWORD -e "SELECT 1" 2>/dev/null; do
                echo "MySQL not ready, waiting..."
                sleep 5
              done
              echo "Creating fleet database..."
              mysql -h fleet-mysql-pxc -uroot -p$MYSQL_ROOT_PASSWORD -e "CREATE DATABASE IF NOT EXISTS fleet CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
              echo "Done!"
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: fleet-mysql-secrets
                  key: root
      restartPolicy: OnFailure
