---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gpu-operator
  namespace: gpu-operator
spec:
  interval: 30m
  chart:
    spec:
      chart: gpu-operator
      version: "v25.10.1"
      sourceRef:
        kind: HelmRepository
        name: nvidia
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3 
  values:
    # Talos uses system extensions for NVIDIA drivers and toolkit
    driver:
      enabled: false

    toolkit:
      enabled: false  # Pre-installed via Talos nvidia-container-toolkit-lts extension

    devicePlugin:
      enabled: true
      config:
        name: "time-slicing-config"
        default: "inference"

    dcgmExporter:
      enabled: true

    gfd:
      enabled: true

    operator:
      defaultRuntime: containerd

    mig:
      strategy: none

    validator:
      driver:
        env:
          - name: DISABLE_DEV_CHAR_SYMLINK_CREATION
            value: "true"
      toolkit:
        enabled: false  # Skip validation, toolkit is pre-installed via Talos extension