---
apiVersion: garage.rajsingh.info/v1alpha1
kind: GarageCluster
metadata:
  name: garage
  namespace: garage-operator-system
spec:
  replicas: 1
  image: dxflrs/garage:v2.1.0

  # Zone is unique per cluster - uses flux substitution
  zone: "${LOCATION}"

  replication:
    factor: 3
    consistencyMode: consistent
    zoneRedundancy: "AtLeast(2)"

  storage:
    metadata:
      size: 1Gi
    data:
      volume:
        size: 100Gi
        storageClassName: "${STORAGECLASS_LONGTERM}"

  network:
    rpcBindPort: 3901
    rpcSecretRef:
      name: garage-rpc-secret
      key: rpc-secret
    service:
      type: ClusterIP
    # Bootstrap peers left empty - federation is handled via remoteClusters below
    bootstrapPeers: []

  # Multi-cluster federation via Tailscale
  # The operator auto-discovers node IDs from remote Admin APIs and connects them
  remoteClusters:
    - name: ottawa
      zone: ottawa
      connection:
        adminApiEndpoint: "http://ottawa-garage-operator:3903"
        adminTokenSecretRef:
          name: garage-admin-token
          key: admin-token
    - name: robbinsdale
      zone: robbinsdale
      connection:
        adminApiEndpoint: "http://robbinsdale-garage-operator:3903"
        adminTokenSecretRef:
          name: garage-admin-token
          key: admin-token
    - name: stpetersburg
      zone: stpetersburg
      connection:
        adminApiEndpoint: "http://stpetersburg-garage-operator:3903"
        adminTokenSecretRef:
          name: garage-admin-token
          key: admin-token

  s3Api:
    enabled: true
    bindPort: 3900
    region: garage

  admin:
    enabled: true
    bindPort: 3903
    adminTokenSecretRef:
      name: garage-admin-token
      key: admin-token

  database:
    engine: lmdb

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi
