---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
spec:
  interval: 30m
  chart:
    spec:
      chart: fluent-bit
      version: "0.48.0"
      sourceRef:
        kind: HelmRepository
        name: fluent
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    config:
      inputs: |
        [INPUT]
            Name              tail
            Path              /var/log/containers/*.log
            Parser            cri
            Tag               kube.*
            Refresh_Interval  10
            Mem_Buf_Limit     50MB
            Skip_Long_Lines   On

      filters: |
        [FILTER]
            Name                kubernetes
            Match               kube.*
            Kube_URL            https://kubernetes.default.svc:443
            Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
            Merge_Log           On
            Keep_Log            Off
            K8S-Logging.Parser  On
            K8S-Logging.Exclude On

        [FILTER]
            Name          lua
            Match         kube.*
            script        /fluent-bit/scripts/rename_fields.lua
            call          rename_k8s_fields

      outputs: |
        [OUTPUT]
            Name                 http
            Match                *
            Host                 victoria-logs-victoria-logs-single-server.monitoring.svc
            Port                 9428
            URI                  /insert/jsonline?_stream_fields=namespace,pod,container&_msg_field=log
            Format               json_lines
            Json_date_key        _time
            Json_date_format     iso8601

    luaScripts:
      rename_fields.lua: |
        function rename_k8s_fields(tag, timestamp, record)
            if record["kubernetes"] then
                local k8s = record["kubernetes"]
                -- Rename namespace_name to pod_namespace
                if k8s["namespace_name"] then
                    k8s["pod_namespace"] = k8s["namespace_name"]
                    k8s["namespace_name"] = nil
                end
                -- Rename labels to pod_labels
                if k8s["labels"] then
                    k8s["pod_labels"] = k8s["labels"]
                    k8s["labels"] = nil
                end
                -- Rename annotations to pod_annotations
                if k8s["annotations"] then
                    k8s["pod_annotations"] = k8s["annotations"]
                    k8s["annotations"] = nil
                end
                record["kubernetes"] = k8s
            end
            return 2, timestamp, record
        end

    tolerations:
      - operator: Exists

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi
