---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
spec:
  interval: 30m
  chart:
    spec:
      chart: fluent-bit
      version: "0.54.1"
      sourceRef:
        kind: HelmRepository
        name: fluent
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    config:
      service: |-
        [SERVICE]
          daemon off
          flush {{ .Values.flush }}
          log_level {{ .Values.logLevel }}
          parsers_file /fluent-bit/etc/parsers.conf
          parsers_file /fluent-bit/etc/conf/custom_parsers.conf
          http_server on
          http_listen 0.0.0.0
          http_port {{ .Values.metricsPort }}
          health_check on

      inputs: |-
        [INPUT]
          name tail
          alias kubernetes
          path /var/log/containers/*.log
          parser containerd
          tag kubernetes.*
          skip_empty_lines on
          skip_long_lines on

      filters: |-
        [FILTER]
          name kubernetes
          match kubernetes.*
          merge_log on
          kube_tag_prefix kubernetes.var.log.containers.
          k8s-logging.parser on
          k8s-logging.exclude on
          namespace_labels off
          annotations off

        [FILTER]
          name modify
          match kubernetes.*
          copy kubernetes.namespace_name kubernetes.pod_namespace
          copy kubernetes.labels.app.kubernetes.io/name app
          copy kubernetes.labels.app app
          copy kubernetes.labels.k8s-app app

      customParsers: |-
        [PARSER]
          name containerd
          format regex
          regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
          time_key time
          time_format %Y-%m-%dT%H:%M:%S.%L%z

      outputs: |-
        [OUTPUT]
          name http
          match kubernetes.*
          host victoria-logs-victoria-logs-single-server.monitoring.svc.cluster.local
          port 9428
          uri /insert/jsonline?_stream_fields=stream,kubernetes.namespace_name,kubernetes.pod_name,kubernetes.container_name,app&_msg_field=log,message,msg,_msg&_time_field=date
          format json_lines
          json_date_format iso8601
          compress gzip
          log_response_payload false

    dashboards:
      enabled: true
    serviceMonitor:
      enabled: true
    logLevel: warn

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi
