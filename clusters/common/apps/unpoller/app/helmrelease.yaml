---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app unpoller
spec:
  interval: 1h
  chart:
    spec:
      chart: unpoller
      version: "*"
      sourceRef:
        kind: HelmRepository
        name: unpoller
        namespace: flux-system
  values:
    fullnameOverride: *app
    resources:
      requests:
        cpu: 10m
        memory: 64Mi
      limits:
        memory: 128Mi
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
    dashboards:
      create: true
      grafana:
        create: true
      selectorLabels:
        grafana.internal/instance: grafana
    upConfig: |
      [poller]
          debug = false
          quiet = false
          plugins = []
      [prometheus]
          disable = false
          http_listen = "0.0.0.0:9130"
          report_errors = false
      [influxdb]
          disable = true
      [unifi]
          dynamic = false
      [loki]
          disable = true
      [[unifi.controller]]
          url         = "https://${LAN_GATEWAY_IP}"
          user        = "unpoller"
          pass        = "Keiretsu${DEFAULT_PASSWORD}0"
          sites       = ["all"]
          save_ids    = true
          save_dpi    = true
          save_sites  = true
          hash_pii    = false
          verify_ssl  = false
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: GrafanaDashboard
            patch: |
              - op: replace
                path: /spec/instanceSelector/matchLabels
                value:
                  grafana.internal/instance: grafana
              - op: add
                path: /spec/folder
                value: UniFi

