name: OpenCode PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review (required for manual trigger)"
        required: true
        type: string

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    if: |
      (github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch') &&
      github.event.pull_request.user.login != 'renovate[bot]' &&
      github.event.pull_request.user.login != 'dependabot[bot]'
    steps:
      - name: Checkout PR
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_PAT }}
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Checkout for dispatch
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config --global user.email "opencode[bot]@users.noreply.github.com"
          git config --global user.name "opencode[bot]"

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: TbqNGJkY5611CNTRL-kvAScMUim511CNTRL
          audience: api.tailscale.com/TbqNGJkY5611CNTRL-kvAScMUim511CNTRL
          tags: tag:ci
          version: 1.92.5
          args: --accept-dns

      - name: Verify Tailscale connectivity
        run: |
          tailscale status | head -n 1
          echo "Testing connectivity to vLLM endpoint..."
          curl -s --connect-timeout 10 http://stpetersburg-vllm/v1/models | jq -r '.data[].id'

      - name: Fetch PR for dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          gh pr checkout ${{ inputs.pr_number }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: OpenCode Review
        uses: anomalyco/opencode/github@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          VLLM_BASE_URL: http://stpetersburg-vllm/v1
        with:
          model: vllm/Qwen3-Coder-Next
          use_github_token: true
          mentions: renovate[bot],dependabot[bot]
          prompt: |
            You are a code reviewer. This is a REVIEW ONLY task. Do NOT modify any files, do NOT create commits, do NOT push code. Only provide written feedback.

            Review ONLY the changes in this pull request for a GitOps Kubernetes manifests repository.

            IMPORTANT: Run `git diff origin/main...HEAD` to see the actual diff. Only review the changed lines - do NOT review pre-existing code that was not modified in this PR.

            For each changed file, focus your review on:
            - YAML syntax and formatting errors in the changed lines
            - Kubernetes resource correctness of new/modified resources
            - Security issues introduced by the changes (secrets exposure, excessive permissions)
            - Flux CD GitOps best practices for the new/modified configuration
            - Kustomize and Helm values correctness in modified sections
            - Helm values correctness in modified sections
            - Resource limits and requests if they were added or changed
            - Research online for any known bugs or reasons not to upgrade if versions were changed

            Do NOT flag issues in unchanged code. Do NOT edit or write any files. Be concise and actionable.
