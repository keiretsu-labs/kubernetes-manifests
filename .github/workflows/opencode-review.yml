name: OpenCode PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review (required for manual trigger)"
        required: true
        type: string

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    if: |
      (github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch') &&
      github.event.pull_request.user.login != 'renovate[bot]' &&
      github.event.pull_request.user.login != 'dependabot[bot]'
    steps:
      - name: Checkout PR
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Checkout for dispatch
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config --global user.email "opencode[bot]@users.noreply.github.com"
          git config --global user.name "opencode[bot]"

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: TbqNGJkY5611CNTRL-kvAScMUim511CNTRL
          audience: api.tailscale.com/TbqNGJkY5611CNTRL-kvAScMUim511CNTRL
          tags: tag:ci
          version: 1.92.5
          args: --accept-dns

      - name: Verify Tailscale connectivity
        run: |
          tailscale status | head -n 1
          echo "Testing connectivity to vLLM endpoint..."
          curl -s --connect-timeout 10 http://stpetersburg-vllm/v1/models | jq -r '.data[].id'

      - name: Fetch PR for dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          gh pr checkout ${{ inputs.pr_number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: OpenCode Review
        uses: anomalyco/opencode/github@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          VLLM_BASE_URL: http://stpetersburg-vllm/v1
        with:
          model: vllm/Qwen3-Coder-Next
          use_github_token: true
          mentions: renovate[bot],dependabot[bot]
          prompt: |
            Review this pull request for a GitOps Kubernetes manifests repository.

            Focus on:
            - YAML syntax and formatting
            - Kubernetes resource correctness
            - Security issues (secrets exposure, excessive permissions)
            - Best practices for Flux CD GitOps
            - Kustomize configuration validity
            - Helm values correctness
            - Resource limits and requests
            - Research online for any known bugs or reasons not to upgrade

            Be concise and actionable in your feedback.
