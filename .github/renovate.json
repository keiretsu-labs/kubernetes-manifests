{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":dependencyDashboard",
    "github>keiretsu-labs/kubernetes-manifests//.renovate/customManagers.json",
    "github>keiretsu-labs/kubernetes-manifests//.renovate/groups.json"
  ],
  "dependencyDashboard": true,
  "dependencyDashboardTitle": "Renovate Dashboard ðŸ¤–",
  "prConcurrentLimit": 0,
  "ignorePaths": ["**/*.sops.*", "**/clusterplex.yaml"],
  "flux": {
    "managerFilePatterns": ["/clusters/.+\\.ya?ml$/"]
  },
  "helm-values": {
    "managerFilePatterns": ["/clusters/.+\\.ya?ml$/"]
  },
  "kubernetes": {
    "managerFilePatterns": ["/clusters/.+\\.ya?ml$/"]
  },
  "packageRules": [
    {
      "description": "Auto merge GitHub Actions minor/patch",
      "matchManagers": ["github-actions"],
      "matchUpdateTypes": ["minor", "patch"],
      "automerge": true
    },
    {
      "description": "Auto merge terraform updates",
      "matchManagers": ["terraform"],
      "automerge": true
    },
    {
      "description": "Auto merge npm updates in .github",
      "matchManagers": ["npm"],
      "matchPaths": [".github/**"],
      "automerge": true
    },
    {
      "description": "Auto merge non-critical, non-media cluster updates",
      "matchManagers": ["flux", "helm-values", "kubernetes", "regex"],
      "matchPaths": ["clusters/**"],
      "automerge": true
    },
    {
      "description": "Disable automerge for media apps",
      "matchPaths": ["clusters/**/apps/media/**", "clusters/**/apps/immich/**"],
      "automerge": false
    },
    {
      "description": "Disable automerge for cluster-critical components",
      "matchPaths": [
        "clusters/**/bootstrap/**",
        "clusters/**/flux/**",
        "clusters/**/apps/cilium/**",
        "clusters/**/apps/rook-ceph/**",
        "clusters/**/apps/tuppr/**",
        "clusters/**/apps/cert-manager/**"
      ],
      "automerge": false
    },
    {
      "description": "Allow select media apps to automerge",
      "matchPaths": [
        "clusters/**/apps/media/app/autobrr/**",
        "clusters/**/apps/media/app/bazarr-1080p/**",
        "clusters/**/apps/media/app/bazarr-4k/**",
        "clusters/**/apps/media/app/bazarr-4kremux/**",
        "clusters/**/apps/media/app/bazarr-anime/**",
        "clusters/**/apps/media/app/configarr/**",
        "clusters/**/apps/media/app/feedcord/**",
        "clusters/**/apps/media/app/jellyfin/**",
        "clusters/**/apps/media/app/jellyseerr/**",
        "clusters/**/apps/media/app/jellystat/**",
        "clusters/**/apps/media/app/lidarr/**",
        "clusters/**/apps/media/app/overseerr/**",
        "clusters/**/apps/media/app/prowlarr/**",
        "clusters/**/apps/media/app/tautulli/**",
        "clusters/**/apps/media/app/tunarr/**",
        "clusters/**/apps/media/app/wizarr/**"
      ],
      "automerge": true
    },
    {
      "description": "Group ARC controller and runner scale set together",
      "matchPackageNames": ["gha-runner-scale-set", "gha-runner-scale-set-controller"],
      "groupName": "actions-runner-controller"
    },
    {
      "description": "Exclude legacy tags with 4-digit build numbers in patch position",
      "matchPackageNames": ["lscr.io/linuxserver/lidarr"],
      "allowedVersions": "/^\\d+\\.\\d+\\.\\d{1,2}$/"
    },
    {
      "description": "Exclude legacy Ubuntu-based tags (20.04.x, 22.04.x) for qbittorrent",
      "matchPackageNames": ["lscr.io/linuxserver/qbittorrent"],
      "allowedVersions": "/^[1-9]\\.\\d+\\.\\d+$/"
    },
    {
      "description": "Rook Ceph operator - UPGRADE FIRST",
      "matchPackageNames": ["rook-ceph"],
      "matchManagers": ["flux"],
      "groupName": "rook-ceph-operator",
      "labels": ["CRITICAL-STORAGE", "MERGE-1st-BEFORE-CEPH"],
      "automerge": false,
      "prBodyNotes": [
        "## :warning: CRITICAL: STORAGE INFRASTRUCTURE",
        "",
        "This upgrades the **Rook operator**.",
        "",
        "### Before merging:",
        "- [ ] Read the [Rook upgrade guide](https://rook.io/docs/rook/latest/Upgrade/rook-upgrade/)",
        "- [ ] Read the [Rook release notes](https://github.com/rook/rook/releases) for this version",
        "- [ ] Check [Rook GitHub issues](https://github.com/rook/rook/issues) for known bugs with this version",
        "- [ ] Verify cluster health before proceeding",
        "",
        "### After merging:",
        "- [ ] Wait for operator rollout to complete",
        "- [ ] Verify cluster returns to healthy state",
        "- [ ] Then proceed with any pending Ceph image upgrades"
      ]
    },
    {
      "description": "Ceph images - UPGRADE AFTER operator",
      "matchPackageNames": ["quay.io/ceph/ceph"],
      "groupName": "ceph-images",
      "labels": ["CRITICAL-STORAGE", "MERGE-2nd-AFTER-ROOK"],
      "automerge": false,
      "prBodyNotes": [
        "## :warning: CRITICAL: STORAGE INFRASTRUCTURE",
        "",
        "This upgrades **Ceph daemon images**.",
        "",
        "### Before merging:",
        "- [ ] **Is there a pending Rook operator PR?** Merge that FIRST",
        "- [ ] Read the [Ceph upgrade guide](https://rook.io/docs/rook/latest/Upgrade/ceph-upgrade/)",
        "- [ ] Check the [Rook release notes](https://github.com/rook/rook/releases) for supported Ceph versions",
        "- [ ] Search [Rook GitHub issues](https://github.com/rook/rook/issues) for problems with this Ceph version",
        "- [ ] Verify cluster health before proceeding",
        "",
        "### After merging:",
        "- [ ] Monitor daemon rollouts (OSD, MON, MGR)",
        "- [ ] Verify cluster returns to healthy state"
      ]
    },
    {
      "description": "Pin Ceph images to specific patch versions for production stability",
      "matchPackageNames": ["quay.io/ceph/ceph"],
      "allowedVersions": "/^v\\d+\\.\\d+\\.\\d+$/"
    },
    {
      "description": "Track official Plex image (format: 1.43.0.10467-hash)",
      "matchPackageNames": ["docker.io/plexinc/pms-docker", "plexinc/pms-docker"],
      "versioning": "regex:^(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)\\.(?<build>\\d+)-(?<revision>[0-9a-fA-F]+)$"
    }
  ]
}
